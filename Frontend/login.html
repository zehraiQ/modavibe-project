<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giriş / Kayıt - ModaVibe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light d-flex align-items-center justify-content-center" style="min-height: 100vh;">

    <a href="index.html" class="position-absolute top-0 end-0 m-4 text-dark fs-3"><i class="fas fa-times"></i></a>

    <div class="card border-0 shadow-lg p-4" style="width: 450px; max-width: 95%;">
        <h3 class="text-center fw-bold mb-4">MODAVIBE HESAP</h3>

        <ul class="nav nav-pills nav-fill mb-4" id="pills-tab">
            <li class="nav-item"><button class="nav-link active rounded-0 border text-dark fw-bold" id="login-tab" data-bs-toggle="pill" data-bs-target="#login-form">GİRİŞ YAP</button></li>
            <li class="nav-item"><button class="nav-link rounded-0 border text-dark fw-bold" id="register-tab" data-bs-toggle="pill" data-bs-target="#register-form">ÜYE OL</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="login-form">
                <form onsubmit="handleLogin(event)">
                    <div class="mb-3"><input type="email" id="login-email" class="form-control" placeholder="E-Posta" required></div>
                    <div class="mb-4"><input type="password" id="login-pass" class="form-control" placeholder="Şifre" required></div>
                    <button type="submit" class="btn btn-dark-custom w-100">GİRİŞ YAP</button>
                </form>
            </div>

            <div class="tab-pane fade" id="register-form">
                <form onsubmit="handleRegister(event)">
                    <div class="mb-2"><input type="text" id="reg-name" class="form-control" placeholder="Ad Soyad" required></div>
                    <div class="mb-2"><input type="email" id="reg-email" class="form-control" placeholder="E-Posta" required></div>
                    <div class="mb-2"><input type="text" id="reg-phone" class="form-control" placeholder="Telefon (5XX...)" required></div>
                    <div class="mb-2"><textarea id="reg-address" class="form-control" placeholder="Açık Adres" rows="2" required></textarea></div>
                    <div class="mb-3"><input type="password" id="reg-pass" class="form-control" placeholder="Şifre" required></div>
                    <button type="submit" class="btn btn-dark-custom w-100">KAYIT OL</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="verifyModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-0">
                <div class="modal-header border-0"><h5 class="modal-title fw-bold">DOĞRULAMA</h5></div>
                <div class="modal-body">
                    <p class="small text-muted">E-posta adresinize gönderilen 6 haneli kodu giriniz.</p>
                    <input type="text" id="verify-code" class="form-control text-center fs-4 letter-spacing-2" maxlength="6">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-dark-custom w-100" onclick="verifyCode()">ONAYLA</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        let pendingEmail = "";

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            
            const res = await apiRequest('/login', 'POST', { email, password });
            if(res.user) {
                localStorage.setItem('user', JSON.stringify(res.user));
                window.location.href = 'index.html';
            } else if (res.needsVerify) {
                pendingEmail = email;
                new bootstrap.Modal(document.getElementById('verifyModal')).show();
            } else {
                alert(res.error);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                phone: document.getElementById('reg-phone').value,
                address: document.getElementById('reg-address').value,
                password: document.getElementById('reg-pass').value
            };

            const res = await apiRequest('/register', 'POST', data);
            if(res.message) {
                pendingEmail = data.email;
                // للمشروع فقط: نعرض الكود في التنبيه لتسهيل الدخول
                if(res.tempCode) alert(`(Test Modu) Kodunuz: ${res.tempCode}`);
                new bootstrap.Modal(document.getElementById('verifyModal')).show();
            } else {
                alert(res.error);
            }
        }

        async function verifyCode() {
            const code = document.getElementById('verify-code').value;
            const res = await apiRequest('/verify', 'POST', { email: pendingEmail, code });
            if(res.message) {
                alert("Hesap doğrulandı! Giriş yapabilirsiniz.");
                location.reload();
            } else {
                alert("Hatalı kod!");
            }
        }
    </script>
</body>
</html>